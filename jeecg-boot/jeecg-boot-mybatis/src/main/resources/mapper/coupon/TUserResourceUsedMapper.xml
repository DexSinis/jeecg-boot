<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.coupon.mapper.TUserResourceUsedMapper">
    <select id="myCoupons" resultType="org.jeecg.modules.vip.vo.TUserResourceVo">
        SELECT * FROM (
        SELECT
        t4.USTATUS AS uStatus,
        t4.id,
        t4.`STATUS` AS status,
        DATE_FORMAT(t4.EXP_DATE, '%Y-%m-%d') as expDate,
        DATE_FORMAT(t4.EFF_DATE, '%Y-%m-%d') as effDate,
        DATE_FORMAT(t4.USING_TIME, '%Y-%m-%d %T') AS usingTime,
        tmr.RESOURCE_ID AS resourceId,
        tmr.RESOURCE_TYPE AS resourceType,
        tmr.RESOURCE_NAME AS resourceName,
        tmr.RES_VALUE AS resValue,
        tmr.TRANS_PAGE AS transPage,
        tmr.RES_VALUE_TYPE AS resValueType,
        tmr.USE_DESC AS useDesc,
        ifnull(tmr.FULL_VALUE,'') AS fullValue ,
        tmri.RESOURCE_INST_ID AS resourceInstId,
        tmr.suit_service_type AS suitServiceType
        from
        (select * from
        (select *,'1' as USTATUS from t_user_resource_used where USER_ID=#{consulterId}
        and status=0 and now()&lt;=EXP_DATE and now()>=EFF_DATE ORDER BY EXP_DATE asc limit 0, 1000) t1
        UNION
        select * from
        (select *,'2' as USTATUS from t_user_resource_used where USER_ID=#{consulterId}
        and status=0 and now()&lt;=EFF_DATE and now()&lt;=EXP_DATE ORDER BY EXP_DATE asc limit 0, 1000) tk
        UNION
        select * from
        (select *,'3' as USTATUS from t_user_resource_used where USER_ID=#{consulterId}
        and status=1 ORDER BY USING_TIME desc limit 0, 1000) t2
        UNION
        select * from
        (select *,'4' as USTATUS from t_user_resource_used where USER_ID=#{consulterId}
        and status=0 and now()>EXP_DATE ORDER BY EXP_DATE desc limit 0, 1000) t3) t4
        left join
        t_mkt_resource_inst tmri on tmri.RESOURCE_INST_ID = t4.RESOURCE_INST_ID
        left join
        t_mkt_resource tmr on tmr.RESOURCE_ID = tmri.RESOURCE_ID
        where UNIX_TIMESTAMP(tmr.CREATE_TIME)>(UNIX_TIMESTAMP(NOW())-7776000)
        and (tmr.suit_pricing_pkg_id is null  or tmr.suit_pricing_pkg_id=-1 )
        and ((tmr.RECEIVE_MOD = 2 and tmri.RECEIVE_STATUS = 1) or (tmr.RECEIVE_MOD = 1))
        <if test='type=="2" '>
            and t4.USTATUS in ('3','4')
        </if>
        <if test='type=="1" '>
            and t4.USTATUS in ('1','2')
        </if>
        )  as s where 1=1
        <if test="serviceId!=null and serviceId!=''">
             and s.suitServiceType in (select rela_id  from t_mkt_service_type_rela where service_type=#{serviceId} or service_type=-1 )
        </if>


    </select>

</mapper>
