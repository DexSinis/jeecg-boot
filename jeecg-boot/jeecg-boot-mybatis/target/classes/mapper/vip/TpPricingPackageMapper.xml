<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.vip.mapper.TpPricingPackageMapper">
    <select id="queryScaleCnt" resultType="java.util.Map">
       SELECT
	tpp.*, (
		SELECT
			COUNT(1)
		FROM
			consulter_order_pkg_pay AS pay
		WHERE
			pay.pay_stauts = 1
		AND pay.pricing_pkg_id = tpp.pricing_pkg_id
	) AS buy_num,
	(select  param_value from bl_sys_system_param where module="CODE" AND PARAM_name ="VIP_USER_CNT" limit 1) AS man_made_buy_num,
	tppr.service_id,
	tppr.free_times,
	tppr.discount_rate,
	tppr.discount_limit_times,
	tppr.discount_desc
FROM
	tp_pricing_package AS tpp
LEFT JOIN tp_pricing_pkg_res AS tppr ON tppr.pricing_pkg_id = tpp.pricing_pkg_id
WHERE
	STATUS = 1 AND pkg_type!=-1
ORDER BY
	tpp.pricing_pkg_id ASC,tpp.create_time asc
    </select>

    <select id="queryConsulterVipInformation" resultType="java.util.Map">
       SELECT
	vip.vip_id AS vipId,
	vip.vip_phone AS vipPhone,
	vip.eff_time AS vipEffTime,
	vip.exp_time AS vipExpTime,
	tpp.PRICING_PKG_NAME AS pricingPkgName,
	tpp.CHARGE_TYPE AS chargeType,
	tpp.EFF_TIME AS pricingEffTime,
	tpp.EXP_TIME AS prcingExpTime,
	tpp.PRICING_DESC AS pricingDesc,
	tpp.MIN_PRICE AS minPrice,
	tpp.sale_cnt_limit AS saleCntLimit,
	tpp.sale_price AS salePrice,
	tpp.marked_price AS markedPrice,
	tpp.pkg_type AS pkgType,
	tpp.pricing_pkg_id AS pricingPkgId,
	tppr.service_id AS serviceId,
	tppr.free_times AS freeTimes,
	tppr.discount_rate AS discountRate,
	tppr.discount_limit_times AS discountLimitTimes
  FROM
	consulter_vip AS vip
INNER JOIN consulter AS c ON vip.vip_phone = c.phone
INNER JOIN consulter_order_pkg_pay AS pay ON vip.vip_phone = pay.moible_phone
AND pay.pay_stauts = 1
INNER JOIN tp_pricing_package AS tpp ON pay.PRICING_PKG_ID = tpp.PRICING_PKG_ID
AND tpp. STATUS = 1
INNER JOIN tp_pricing_pkg_res AS tppr ON tpp.pricing_pkg_id = tppr.pricing_pkg_id
WHERE
	c.id = #{consulterId}
AND c.b_mark = #{bMark}
AND vip. STATUS = 1
AND vip.exp_time > now()
ORDER BY
	vip.exp_time ASC

    </select>

</mapper>
